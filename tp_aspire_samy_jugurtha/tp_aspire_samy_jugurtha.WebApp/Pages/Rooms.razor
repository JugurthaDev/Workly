@page "/rooms"
@using Microsoft.AspNetCore.Components.Authorization
@using tp_aspire_samy_jugurtha.WebApp.Components
@using tp_aspire_samy_jugurtha.WebApp.Clients
@using tp_aspire_samy_jugurtha.WebApp.Models
@using System.Net
@inject IWorklyClient Api
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Salles - Workly</PageTitle>

<RoomDetailsModal IsVisible="_showModal" Room="_selectedRoom" OnClose="CloseModal" />
<RoomBookingModal IsVisible="_showBookingModal"
                  Room="_roomToBook"
                  CurrentUserLabel="@_currentUserLabel"
                  OnClose="CloseBookingModal"
                  OnBooked="OnBookingCompleted" />

<div class="rooms-page-modern">
    <div class="dashboard-hero">
        <div class="hero-text">
            <h1 class="dashboard-title">Salles disponibles</h1>
            <p class="dashboard-subtitle">Consultez et r√©servez les espaces de travail disponibles</p>
        </div>
        <div class="view-tabs">
            <button class="tab-btn @(_activeView == "list" ? "active" : "")" @onclick='() => SetView("list")'>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                </svg>
                Vue Liste
            </button>
            <button class="tab-btn @(_activeView == "plan" ? "active" : "")" @onclick='() => SetView("plan")'>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="2"></rect>
                    <rect x="6" y="6" width="5" height="5" fill="currentColor" opacity="0.3"></rect>
                    <rect x="13" y="6" width="5" height="5" fill="currentColor" opacity="0.3"></rect>
                    <rect x="6" y="13" width="5" height="5" fill="currentColor" opacity="0.3"></rect>
                    <rect x="13" y="13" width="5" height="5" fill="currentColor" opacity="0.3"></rect>
                </svg>
                Vue Interactive
            </button>
        </div>
    </div>

<AuthorizeView Roles="admin">
    <Authorized>
        <div class="card mb-4">
            <div class="card-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Ajouter une nouvelle salle
            </div>
            <div class="card-body">
                <AddRoomForm OnRoomAdded="LoadRooms" />
            </div>
        </div>
    </Authorized>
</AuthorizeView>

@if (rooms is null)
{
    <div class="loading">
        <div class="spinner"></div>
        <p class="mt-2">Chargement des salles...</p>
    </div>
}
else if (!rooms.Any())
{
    <div class="card">
        <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
                <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
            <div class="empty-state-title">Aucune salle disponible</div>
            <p class="empty-state-description">Commencez par ajouter votre premi√®re salle en utilisant le formulaire ci-dessus.</p>
        </div>
    </div>
}
else
{
    @if (_activeView == "list")
    {
        <div class="rooms-modern-grid">
        @foreach (var room in rooms)
        {
            <div class="room-modern-card">
                <div class="room-card-image" style="background-image: url('@(room.ImageUrl ?? "/images/rooms/default.jpg")')">
                    <div class="room-card-overlay"></div>
                    <div class="room-card-header">
                        <div class="room-card-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="9"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <span class="badge badge-success">Disponible</span>
                    </div>
                </div>
                
                <div class="room-card-content">
                    <h3 class="room-card-title">@room.Name</h3>
                    
                    <div class="room-card-details">
                    <div class="detail-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Capacit√©: <strong>@room.Capacity personnes</strong></span>
                    </div>
                    
                    <div class="detail-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Lieu: <strong>@room.Location</strong></span>
                    </div>
                </div>
                
                <div class="room-card-actions">
                    <button class="btn btn-primary btn-sm" @onclick="() => QuickBookRoom(room)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        R√©server
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="() => ShowRoomDetails(room)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        D√©tails
                    </button>
                </div>
                </div>
            </div>
        }
    </div>
    }
    else
    {
        <div class="building-container">
            <svg class="building-plan" viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="4"/>
                        <feOffset dx="3" dy="3" result="offsetblur"/>
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.4"/>
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>

                    <filter id="innerShadow">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                        <feOffset dx="0" dy="2" result="offsetblur"/>
                        <feFlood flood-color="#000000" flood-opacity="0.15"/>
                        <feComposite in2="offsetblur" operator="in"/>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>

                    <linearGradient id="floorGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#fafafa;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#f0f0f0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#e8e8e8;stop-opacity:1" />
                    </linearGradient>

                    <pattern id="tilePattern" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
                        <rect width="60" height="60" fill="#f9f9f9"/>
                        <path d="M 0 0 L 60 0 L 60 60 L 0 60 Z" fill="none" stroke="#e5e5e5" stroke-width="1.5"/>
                        <circle cx="30" cy="30" r="2" fill="#ddd" opacity="0.3"/>
                    </pattern>

                    <linearGradient id="corridorGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" style="stop-color:#c8c8c8;stop-opacity:0.7" />
                        <stop offset="50%" style="stop-color:#d0d0d0;stop-opacity:0.8" />
                        <stop offset="100%" style="stop-color:#c8c8c8;stop-opacity:0.7" />
                    </linearGradient>

                    <linearGradient id="roomAvailable" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#63e6be;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#38d9a9;stop-opacity:1" />
                    </linearGradient>

                    <linearGradient id="roomOccupied" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff8787;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#ff6b6b;stop-opacity:1" />
                    </linearGradient>

                    <pattern id="woodPattern" x="0" y="0" width="4" height="30" patternUnits="userSpaceOnUse">
                        <rect width="4" height="30" fill="#8b4513"/>
                        <line x1="0" y1="0" x2="0" y2="30" stroke="#5c2e0f" stroke-width="0.5"/>
                    </pattern>
                </defs>

                <rect x="50" y="50" width="1100" height="700" fill="url(#floorGradient)" rx="15"/>
                <rect x="50" y="50" width="1100" height="700" fill="url(#tilePattern)" rx="15"/>
                <rect x="50" y="345" width="1100" height="110" fill="url(#corridorGradient)" filter="url(#innerShadow)" rx="5"/>
                <rect x="545" y="50" width="110" height="700" fill="url(#corridorGradient)" filter="url(#innerShadow)" rx="5"/>
                <line x1="100" y1="400" x2="1100" y2="400" stroke="#fff" stroke-width="2" stroke-dasharray="15,10" opacity="0.4"/>
                <rect x="50" y="50" width="1100" height="700" fill="none" stroke="#2c3e50" stroke-width="6" rx="15"/>
                <rect x="52" y="52" width="1096" height="696" fill="none" stroke="#34495e" stroke-width="2" rx="14" opacity="0.5"/>

                @{
                    var roomPositions = GenerateRoomPositions();
                    int index = 0;
                }

                @foreach (var room in rooms)
                {
                    if (index >= roomPositions.Count) break;
                    
                    var pos = roomPositions[index];
                    var isOccupied = IsRoomOccupied(room.Id);
                    var fillGradient = isOccupied ? "url(#roomOccupied)" : "url(#roomAvailable)";
                    
                    <g class="room-group" @onclick="() => QuickBookRoom(room)" style="cursor: pointer;">
                        <rect x="@pos.X" y="@pos.Y" width="@pos.Width" height="@pos.Height" 
                              fill="@fillGradient" 
                              stroke="#2c3e50" 
                              stroke-width="4" 
                              rx="12"
                              filter="url(#shadow)"
                              class="room-rect"/>
                        
                        <rect x="@(pos.X + 3)" y="@(pos.Y + 3)" width="@(pos.Width - 6)" height="@(pos.Height - 6)" 
                              fill="none" 
                              stroke="white"
                              stroke-width="2"
                              opacity="0.3" 
                              rx="10"/>
                        
                        <rect x="@(pos.X + 10)" y="@(pos.Y + 10)" width="@(pos.Width - 20)" height="30" 
                              fill="white" 
                              opacity="0.15" 
                              rx="8"/>
                        
                        @{
                            var doorX = pos.X + pos.Width / 2 - 18;
                            var doorY = GetDoorPosition(pos);
                        }
                        <rect x="@doorX" y="@doorY" width="36" height="10" fill="url(#woodPattern)" stroke="#3d2817" stroke-width="2" rx="3"/>
                        <rect x="@(doorX + 2)" y="@(doorY + 2)" width="32" height="6" fill="#a0522d" opacity="0.5" rx="2"/>
                        <circle cx="@(doorX + 6)" cy="@(doorY + 5)" r="2" fill="#ffd700" stroke="#b8860b" stroke-width="0.5"/>
                        
                        @if (pos.Width > 150)
                        {
                            <rect x="@(pos.X + 15)" y="@(pos.Y + 15)" width="35" height="30" fill="#b8d8f5" stroke="#2c3e50" stroke-width="3" opacity="0.8" rx="4"/>
                            <rect x="@(pos.X + 18)" y="@(pos.Y + 18)" width="29" height="24" fill="#e3f2fd" opacity="0.6" rx="3"/>
                            <line x1="@(pos.X + 32)" y1="@(pos.Y + 15)" x2="@(pos.X + 32)" y2="@(pos.Y + 45)" stroke="#2c3e50" stroke-width="2"/>
                            <line x1="@(pos.X + 15)" y1="@(pos.Y + 30)" x2="@(pos.X + 50)" y2="@(pos.Y + 30)" stroke="#2c3e50" stroke-width="2"/>
                            
                            <rect x="@(pos.X + pos.Width - 50)" y="@(pos.Y + 15)" width="35" height="30" fill="#b8d8f5" stroke="#2c3e50" stroke-width="3" opacity="0.8" rx="4"/>
                            <rect x="@(pos.X + pos.Width - 47)" y="@(pos.Y + 18)" width="29" height="24" fill="#e3f2fd" opacity="0.6" rx="3"/>
                            <line x1="@(pos.X + pos.Width - 33)" y1="@(pos.Y + 15)" x2="@(pos.X + pos.Width - 33)" y2="@(pos.Y + 45)" stroke="#2c3e50" stroke-width="2"/>
                            <line x1="@(pos.X + pos.Width - 50)" y1="@(pos.Y + 30)" x2="@(pos.X + pos.Width - 15)" y2="@(pos.Y + 30)" stroke="#2c3e50" stroke-width="2"/>
                        }
                        
                        @{
                            var tableWidth = Math.Min(pos.Width * 0.45, 70);
                            var tableHeight = Math.Min(pos.Height * 0.35, 45);
                            var tableX = pos.X + pos.Width / 2 - tableWidth / 2;
                            var tableY = pos.Y + pos.Height / 2 - tableHeight / 2;
                        }
                        <ellipse cx="@(tableX + tableWidth / 2)" cy="@(tableY + tableHeight + 3)" rx="@(tableWidth / 2)" ry="5" fill="#000" opacity="0.2"/>
                        <rect x="@tableX" y="@tableY" width="@tableWidth" height="@tableHeight" 
                              fill="#6d4c41" 
                              stroke="#4e342e" 
                              stroke-width="2.5" 
                              rx="6"
                              opacity="0.7"/>
                        
                        <rect x="@(pos.X + pos.Width / 2 - 50)" y="@(pos.Y + pos.Height - 50)" width="100" height="28" 
                              fill="#2c3e50" 
                              stroke="#1a252f"
                              stroke-width="2"
                              opacity="0.9" 
                              rx="14"/>
                        
                        <text x="@(pos.X + pos.Width / 2)" 
                              y="@(pos.Y + pos.Height - 30)" 
                              text-anchor="middle" 
                              font-size="15" 
                              font-weight="bold" 
                              fill="#fff"
                              style="pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            @room.Name
                        </text>
                        
                        <rect x="@(pos.X + pos.Width / 2 - 40)" y="@(pos.Y + pos.Height - 80)" width="80" height="22" 
                              fill="white" 
                              opacity="0.25" 
                              rx="11"/>
                        
                        <text x="@(pos.X + pos.Width / 2)" 
                              y="@(pos.Y + pos.Height - 64)" 
                              text-anchor="middle" 
                              font-size="13" 
                              font-weight="600"
                              fill="#fff"
                              style="pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.4);">
                            üë• @room.Capacity
                        </text>
                    </g>
                    
                    index++;
                }

                <g class="stairs">
                    <rect x="1095" y="355" width="50" height="90" fill="#7c7c7c" stroke="#2c3e50" stroke-width="3" rx="6" filter="url(#shadow)"/>
                    @for (int i = 0; i < 7; i++)
                    {
                        <rect x="1100" y="@(365 + i * 11)" width="40" height="8" fill="#646464" stroke="#4a4a4a" stroke-width="1.5" rx="1"/>
                    }
                    <text x="1120" y="398" text-anchor="middle" font-size="24" font-weight="bold" fill="#fff" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">‚Üï</text>
                </g>

                <g class="emergency-exit">
                    <rect x="55" y="355" width="38" height="90" fill="#e53935" stroke="#b71c1c" stroke-width="3" rx="6" filter="url(#shadow)"/>
                    <text x="74" y="410" text-anchor="middle" font-size="20" font-weight="bold" fill="#fff">EXIT</text>
                </g>

                <g class="restrooms">
                    <rect x="95" y="665" width="90" height="75" fill="#5c7cfa" stroke="#364fc7" stroke-width="3" rx="8" filter="url(#shadow)"/>
                    <circle cx="120" cy="695" r="8" fill="#fff" opacity="0.9"/>
                    <path d="M 120 703 L 120 720 M 113 710 L 127 710" stroke="#fff" stroke-width="3" opacity="0.9"/>
                    <circle cx="160" cy="695" r="8" fill="#fff" opacity="0.9"/>
                    <path d="M 160 703 L 160 720 M 153 710 L 167 710 M 160 720 L 153 730 M 160 720 L 167 730" stroke="#fff" stroke-width="3" opacity="0.9"/>
                </g>
            </svg>
        </div>
    }
}
</div>

<style>
    .rooms-page-modern {
        animation: fadeInUp 0.6s ease;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dashboard-hero {
        background: linear-gradient(135deg, #f8f9fc 0%, #fff 100%);
        padding: 2rem 2.5rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(26, 35, 50, 0.05) 100%);
        border-radius: 50%;
        z-index: 0;
    }

    .hero-text {
        position: relative;
        z-index: 1;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .dashboard-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        margin: 0;
    }

    .view-tabs {
        display: flex;
        gap: 0.75rem;
        z-index: 1;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: 2px solid transparent;
        background: white;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-btn:hover {
        background: #f8f9fc;
        transform: translateY(-2px);
    }

    .tab-btn.active {
        background: linear-gradient(135deg, #ff6b35 0%, #f25c28 100%);
        color: white;
        border-color: #ff6b35;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .tab-btn svg {
        width: 20px;
        height: 20px;
    }

    .building-container {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 24px;
        padding: 2.5rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow-x: auto;
        position: relative;
        margin-top: 1rem;
    }

    .building-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #ff6b35, #f7b731, #5f27cd, #ff6b35);
        background-size: 300% 100%;
        border-radius: 24px 24px 0 0;
        animation: gradientShift 4s ease infinite;
    }

    @@keyframes gradientShift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    .building-plan {
        width: 100%;
        height: auto;
        max-height: 75vh;
        min-height: 650px;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.05));
    }

    .room-group {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: center;
    }

    .room-group:hover {
        transform: scale(1.05);
        filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.25));
    }

    .room-group:hover .room-rect {
        stroke-width: 5;
        filter: url(#shadow) brightness(1.15) contrast(1.1);
    }

    .room-group:active {
        transform: scale(0.98);
    }

    .room-rect {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @@media (max-width: 768px) {
        .dashboard-hero {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .view-tabs {
            width: 100%;
        }

        .tab-btn {
            flex: 1;
            justify-content: center;
        }
    }
</style>

@code {
    private List<Room>? rooms;
    private List<Booking>? _bookings;
    private bool _showModal = false;
    private bool _showBookingModal = false;
    private Room? _selectedRoom;
    private Room? _roomToBook;
    private string _currentUserLabel = string.Empty;
    private string _activeView = "list";

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    public class RoomPosition
    {
        public double X { get; set; }
        public double Y { get; set; }
        public double Width { get; set; }
        public double Height { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _currentUserLabel = user?.FindFirst("email")?.Value
            ?? user?.FindFirst("preferred_username")?.Value
            ?? user?.Identity?.Name
            ?? "Utilisateur Workly";

        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        try
        {
            rooms = await Api.GetRoomsAsync();
            _bookings = await Api.GetBookingsAsync();
        }
        catch (UnauthorizedAccessException)
        {
            var ret = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/authentication/login?returnUrl={ret}", forceLoad: true);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.Unauthorized || ex.StatusCode == HttpStatusCode.Forbidden)
        {
            var ret = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/authentication/login?returnUrl={ret}", forceLoad: true);
        }
        catch (Exception)
        {
            Layout?.ShowErrorNotification("Erreur", "Impossible de charger les salles pour le moment.");
            rooms = new();
            _bookings = new();
        }
    }

    private void SetView(string view)
    {
        _activeView = view;
        StateHasChanged();
    }

    private List<RoomPosition> GenerateRoomPositions()
    {
        return new List<RoomPosition>
        {
            new RoomPosition { X = 80, Y = 80, Width = 240, Height = 240 },
            new RoomPosition { X = 340, Y = 80, Width = 180, Height = 240 },
            new RoomPosition { X = 680, Y = 80, Width = 180, Height = 240 },
            new RoomPosition { X = 880, Y = 80, Width = 240, Height = 240 },
            new RoomPosition { X = 200, Y = 480, Width = 180, Height = 240 },
            new RoomPosition { X = 400, Y = 480, Width = 180, Height = 240 },
            new RoomPosition { X = 680, Y = 480, Width = 180, Height = 240 },
            new RoomPosition { X = 880, Y = 480, Width = 240, Height = 240 },
        };
    }

    private double GetDoorPosition(RoomPosition pos)
    {
        return pos.Y < 300 ? pos.Y + pos.Height - 8 : pos.Y;
    }

    private bool IsRoomOccupied(int roomId)
    {
        if (_bookings == null) return false;
        
        var now = DateTime.UtcNow;
        return _bookings.Any(b => 
            b.ResourceId == roomId && 
            b.ResourceType == ResourceType.Room &&
            b.StartUtc <= now && 
            b.EndUtc >= now);
    }

    private void ShowRoomDetails(Room room)
    {
        _selectedRoom = room;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
        _selectedRoom = null;
    }

    private void QuickBookRoom(Room room)
    {
        if (_activeView == "plan" && IsRoomOccupied(room.Id))
        {
            Layout?.ShowWarningNotification(
                "Salle occup√©e",
                $"{room.Name} est actuellement occup√©e."
            );
            return;
        }
        
        _roomToBook = room;
        _showBookingModal = true;
        StateHasChanged();
    }

    private Task CloseBookingModal()
    {
        _showBookingModal = false;
        _roomToBook = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnBookingCompleted(Room room)
    {
        Layout?.ShowSuccessNotification(
            "R√©servation confirm√©e",
            $"{room.Name} a √©t√© r√©serv√©e."
        );

        await LoadRooms();
    }
}