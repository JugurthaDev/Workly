@page "/rooms"
@using Microsoft.AspNetCore.Components.Authorization
@using tp_aspire_samy_jugurtha.WebApp.Components
@using tp_aspire_samy_jugurtha.WebApp.Clients
@using tp_aspire_samy_jugurtha.WebApp.Models
@using System.Net
@inject IWorklyClient Api
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Salles - Workly</PageTitle>

<RoomDetailsModal IsVisible="_showModal" Room="_selectedRoom" OnClose="CloseModal" OnBook="HandleBookRoom" />
<RoomBookingModal IsVisible="_showBookingModal"
                  Room="_roomToBook"
                  CurrentUserLabel="@_currentUserLabel"
                  OnClose="CloseBookingModal"
                  OnBooked="OnBookingCompleted" />

<div class="rooms-page-modern">
    <div class="dashboard-hero">
        <div class="hero-text">
            <h1 class="dashboard-title">Salles disponibles</h1>
            <p class="dashboard-subtitle">Consultez et réservez les espaces de travail disponibles</p>
        </div>
    </div>

<AuthorizeView Roles="admin">
    <Authorized>
        <div class="card mb-4">
            <div class="card-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Ajouter une nouvelle salle
            </div>
            <div class="card-body">
                <AddRoomForm OnRoomAdded="LoadRooms" />
            </div>
        </div>
    </Authorized>
</AuthorizeView>

@if (rooms is null)
{
    <div class="loading">
        <div class="spinner"></div>
        <p class="mt-2">Chargement des salles...</p>
    </div>
}
else if (!rooms.Any())
{
    <div class="card">
        <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="3" x2="9" y2="21"></line>
                <line x1="15" y1="3" x2="15" y2="21"></line>
            </svg>
            <div class="empty-state-title">Aucune salle disponible</div>
            <p class="empty-state-description">Commencez par ajouter votre première salle en utilisant le formulaire ci-dessus.</p>
        </div>
    </div>
}
else
{
    <div class="rooms-modern-grid">
        @foreach (var room in rooms)
        {
            <div class="room-modern-card">
                <div class="room-card-header">
                    <div class="room-card-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                    </div>
                    <span class="badge badge-success">Disponible</span>
                </div>
                
                <h3 class="room-card-title">@room.Name</h3>
                
                <div class="room-card-details">
                    <div class="detail-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Capacité: <strong>@room.Capacity personnes</strong></span>
                    </div>
                    
                    <div class="detail-item">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>Lieu: <strong>@room.Location</strong></span>
                    </div>
                </div>
                
                <div class="room-card-actions">
                    <button class="btn btn-primary btn-sm" @onclick="() => QuickBookRoom(room)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Réserver
                    </button>
                    <button class="btn btn-secondary btn-sm" @onclick="() => ShowRoomDetails(room)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Détails
                    </button>
                </div>
            </div>
        }
    </div>
}
</div>

<style>
    .rooms-page-modern {
        animation: fadeInUp 0.6s ease;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dashboard-hero {
        background: linear-gradient(135deg, #f8f9fc 0%, #fff 100%);
        padding: 2rem 2.5rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(26, 35, 50, 0.05) 100%);
        border-radius: 50%;
        z-index: 0;
    }

    .hero-text {
        position: relative;
        z-index: 1;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .dashboard-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        margin: 0;
    }
</style>

@code {
    private List<Room>? rooms;
    private bool _showModal = false;
    private bool _showBookingModal = false;
    private Room? _selectedRoom;
    private Room? _roomToBook;
    private string _currentUserLabel = string.Empty;

    [CascadingParameter]
    public MainLayout? Layout { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _currentUserLabel = user?.FindFirst("email")?.Value
            ?? user?.FindFirst("preferred_username")?.Value
            ?? user?.Identity?.Name
            ?? "Utilisateur Workly";

        await LoadRooms();
    }

    private async Task LoadRooms()
    {
        try
        {
            rooms = await Api.GetRoomsAsync();
        }
        catch (UnauthorizedAccessException)
        {
            var ret = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/authentication/login?returnUrl={ret}", forceLoad: true);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.Unauthorized || ex.StatusCode == HttpStatusCode.Forbidden)
        {
            // Si pas de token ou expiré: relance le challenge OIDC
            var ret = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/authentication/login?returnUrl={ret}", forceLoad: true);
        }
        catch (Exception)
        {
            // Autres erreurs backend: affiche une notif sympathique et évite de casser la page
            Layout?.ShowErrorNotification("Erreur", "Impossible de charger les salles pour le moment.");
            rooms = new();
        }
    }

    private void ShowRoomDetails(Room room)
    {
        _selectedRoom = room;
        _showModal = true;
    }

    private void CloseModal()
    {
        _showModal = false;
        _selectedRoom = null;
    }

    private void QuickBookRoom(Room room)
        => OpenBookingModal(room);

    private void HandleBookRoom(Room room)
    {
        CloseModal();
        OpenBookingModal(room);
    }

    private void OpenBookingModal(Room room)
    {
        _roomToBook = room;
        _showBookingModal = true;
        StateHasChanged();
    }

    private Task CloseBookingModal()
    {
        _showBookingModal = false;
        _roomToBook = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnBookingCompleted(Room room)
    {
        Layout?.ShowSuccessNotification(
            "Réservation confirmée",
            $"{room.Name} a été réservée."
        );

        await LoadRooms();
    }
}