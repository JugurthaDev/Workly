@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using tp_aspire_samy_jugurtha.WebApp.Clients
@using tp_aspire_samy_jugurtha.WebApp.Models
@attribute [Authorize(Roles = Roles.Admin)]
@inject IWorklyClient Api

<PageTitle>Administration - Workly</PageTitle>

<div class="admin-modern">
    <div class="dashboard-hero">
        <div class="hero-text">
            <h1 class="dashboard-title">Administration</h1>
            <p class="dashboard-subtitle">Gestion de toutes les réservations du système</p>
        </div>
    </div>

    @if (bookings is null)
    {
        <div class="loading-state">
            <div class="spinner-modern"></div>
            <p class="loading-text">Chargement des réservations...</p>
        </div>
    }
    else if (!bookings.Any())
    {
        <div class="card">
            <div class="empty-modern-state">
                <div class="empty-modern-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="empty-modern-title">Aucune réservation</div>
                <p class="empty-modern-description">Il n'y a actuellement aucune réservation dans le système.</p>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Toutes les réservations (@bookings.Count)</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Utilisateur</th>
                            <th>Salle</th>
                            <th>Date début</th>
                            <th>Date fin</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var booking in bookings.OrderByDescending(b => b.StartUtc))
                        {
                            <tr>
                                <td><strong>#@booking.Id</strong></td>
                                <td>@booking.AppUserId</td>
                                <td>@GetResourceName(booking)</td>
                                <td>@booking.StartUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@booking.EndUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteBooking(booking.Id)">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Supprimer
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Booking>? bookings;

    /// <summary>Initialise le composant et charge les réservations</summary>
    protected override async Task OnInitializedAsync() => 
        await LoadBookings();

    private async Task LoadBookings()
    {
        try
        {
            bookings = await Api.GetAllBookingsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors du chargement des réservations: {ex.Message}");
            bookings = [];
        }
    }

    private string GetResourceName(Booking booking) => booking.ResourceType switch
    {
        ResourceType.Room => $"Salle #{booking.ResourceId}",
        ResourceType.Desk => $"Bureau #{booking.ResourceId}",
        _ => $"Resource #{booking.ResourceId}"
    };

    /// <summary>Supprime une réservation</summary>
    private async Task DeleteBooking(int bookingId)
    {
        try
        {
            await Api.DeleteBookingAsync(bookingId);
            await LoadBookings();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erreur lors de la suppression: {ex.Message}");
        }
    }
}

<style>
    .admin-modern {
        animation: fadeInUp 0.6s ease;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dashboard-hero {
        background: linear-gradient(135deg, #f8f9fc 0%, #fff 100%);
        padding: 2rem 2.5rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.08) 0%, rgba(26, 35, 50, 0.05) 100%);
        border-radius: 50%;
        z-index: 0;
    }

    .hero-text {
        position: relative;
        z-index: 1;
    }

    .dashboard-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .dashboard-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        margin: 0;
    }

    .loading-state {
        text-align: center;
        padding: 5rem 2rem;
    }

    .spinner-modern {
        width: 50px;
        height: 50px;
        border: 4px solid var(--bg-secondary);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 500;
    }

    .empty-modern-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-modern-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 107, 53, 0.05) 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .empty-modern-icon svg {
        width: 40px;
        height: 40px;
        stroke: var(--accent);
        opacity: 0.5;
    }

    .empty-modern-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary);
    }

    .empty-modern-description {
        color: var(--text-secondary);
        font-size: 1rem;
    }
</style>
