@using System.ComponentModel.DataAnnotations
@using tp_aspire_samy_jugurtha.WebApp.Clients
@using tp_aspire_samy_jugurtha.WebApp.Models
@inject IWorklyClient Api

<EditForm EditContext="editContext" OnValidSubmit="Submit" FormName="add-room-form">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <h4>Add a new room</h4>

    <div class="mb-2">
        <label class="form-label">Workspace</label>
        <InputSelect @bind-Value="Model.WorkspaceId" class="form-select">
            <option value="">-- select --</option>
            @foreach (var w in Workspaces)
            {
                <option value="@w.Id">@w.Name (@w.City)</option>
            }
        </InputSelect>
        <ValidationMessage For="() => Model.WorkspaceId" />
        @if (!string.IsNullOrEmpty(validationMessage))
        {
            <div class="text-danger">@validationMessage</div>
        }
    </div>

    <div class="mb-2">
        <label class="form-label">Name</label>
        <InputText @bind-Value="Model.Name" class="form-control" placeholder="Ex: Salle Innovation" />
        <ValidationMessage For="() => Model.Name" />
    </div>

    <div class="mb-2">
        <label class="form-label">Location</label>
        <InputText @bind-Value="Model.Location" class="form-control" placeholder="Ex: Étage 2, Aile Est" />
        <ValidationMessage For="() => Model.Location" />
    </div>

    <div class="mb-3">
        <label class="form-label">Capacity</label>
        <InputNumber @bind-Value="Model.Capacity" class="form-control" />
        <ValidationMessage For="() => Model.Capacity" />
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
</EditForm>

@code {
    public class RoomInput
    {
        [Required]
        [Range(1, int.MaxValue)]
        public int WorkspaceId { get; set; }
        [Required, MaxLength(150)]
        public string Name { get; set; } = string.Empty;

        [Required, MaxLength(200)]
        public string Location { get; set; } = string.Empty;

        [Range(1, 200)]
        public int Capacity { get; set; } = 4;
    }

    private RoomInput Model = new();
    private EditContext? editContext;
    private List<Workspace> Workspaces = new();

    [Parameter] public EventCallback OnRoomAdded { get; set; } // notifie la page parente

    protected override void OnInitialized()
    {
        editContext = new EditContext(Model);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Workspaces = await Api.GetWorkspacesAsync();
            if (Workspaces.Count == 1)
            {
                Model.WorkspaceId = Workspaces[0].Id;
            }
            StateHasChanged();
        }
    }

    private async Task Submit()
    {
        if (Model.WorkspaceId <= 0)
        {
            return; // validation côté UI déjà affichée
        }

        Room? created = null;
        try
        {
            created = await Api.CreateRoomAsync(new Room
            {
                WorkspaceId = Model.WorkspaceId,
                Name = Model.Name,
                Location = Model.Location,
                Capacity = Model.Capacity
            });
        }
        catch (InvalidOperationException ex)
        {
            validationMessage = ex.Message;
            StateHasChanged();
            return;
        }
        catch (UnauthorizedAccessException)
        {
            validationMessage = "Vous n'avez pas les droits nécessaires pour créer une salle.";
            StateHasChanged();
            return;
        }
        catch (Exception)
        {
            validationMessage = "Une erreur est survenue lors de la création de la salle.";
            StateHasChanged();
            return;
        }

        if (created is not null)
        {
            await OnRoomAdded.InvokeAsync(); // demande à la page de recharger sa liste
            Model = new RoomInput();         // reset du formulaire
            editContext = new EditContext(Model);
            validationMessage = null;
            StateHasChanged();
        }
    }

    private string? validationMessage;
}
